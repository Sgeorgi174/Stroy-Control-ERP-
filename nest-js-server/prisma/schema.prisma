generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id String @id @default(uuid())

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  firstName String @map("first_name")
  lastName  String @map("last_name")

  phone String @unique

  // Primary foreman relation
  primaryObjects Object[] @relation("PrimaryForeman")

  // Secondary foreman relation
  secondaryObjects Object[] @relation("SecondaryForeman")

  createdShifts         Shift[]
  createdShiftTemplates ShiftTemplate[]

  role Roles

  verificationCode     VerifacationCode?
  clothesHistory       ClothesHistory[]
  toolsHistory         ToolHistory[]
  toolsStatusHistories ToolStatusHistory[]
  devicesHistory       DeviceHistory[]
  deviceStatusHistory  DeviceStatusHistory[]
  tabletsHistory       TabletHistory[]
  archiveHistory       EmployeeArchive[]
  actionLogs           ActionLog[]
}

enum Roles {
  OWNER
  MASTER
  ACCOUNTANT
  FOREMAN
  ADMIN
  ASSISTANT_MANAGER
  HR
}

model VerifacationCode {
  id String @id @default(uuid())

  createdAt DateTime @default(now()) @map("created_at")

  code    Int
  codeExp DateTime

  forUser User?   @relation(fields: [userId], references: [id])
  userId  String? @unique @map("user_id")
}

model TelegramUser {
  id String @id @default(uuid())

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  phone                      String        @unique
  chatId                     String        @unique
  photoRequestedTransferId   String?
  photoRequestedTransferType TransferType?
}

enum TransferType {
  TOOL
  DEVICE
  CLOTHES
}

model Object {
  id String @id @default(uuid())

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  name      String
  address   String
  isPending Boolean      @default(false)
  status    ObjectStatus @default(OPEN)

  foreman User?   @relation("PrimaryForeman", fields: [userId], references: [id])
  userId  String?

  foremanSecondary User?   @relation("SecondaryForeman", fields: [secondaryUserId], references: [id])
  secondaryUserId  String?

  customer   Customer? @relation(fields: [customerId], references: [id])
  customerId String?

  tools                Tool[]
  employees            Employee[]
  clothes              Clothes[]
  devices              Device[]
  shifts               Shift[]
  shiftsTemplate       ShiftTemplate[]
  fromClothesHistories ClothesHistory[] @relation("clothes_from_object_fk")
  toClothesHistories   ClothesHistory[] @relation("clothes_to_object_fk")

  fromToolHistories         ToolHistory[]           @relation("tool_from_object_fk")
  toToolHistories           ToolHistory[]           @relation("tool_to_object_fk")
  fromPendingTransfersTools PendingTransfersTools[] @relation("pending_tools_from_object_fk")
  toPendingTransfersTools   PendingTransfersTools[] @relation("pending_tools_to_object_fk")

  fromDeviceHistories         DeviceHistory[]           @relation("device_from_object_fk")
  toDeviceHistories           DeviceHistory[]           @relation("device_to_object_fk")
  fromPendingTransfersDevices PendingTransfersDevices[] @relation("pending_devices_from_object_fk")
  toPendingTransfersDevices   PendingTransfersDevices[] @relation("pending_devices_to_object_fk")

  fromPendingTransfersClothes PendingTransfersClothes[] @relation("pending_clothes_from_object_fk")
  toPendingTransfersClothes   PendingTransfersClothes[] @relation("pending_clothes_to_object_fk")

  @@unique([name, address], name: "object_name_address_unique")
}

model Customer {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  name      String   @unique
  shortName String?
  objects   Object[]
}

enum ObjectStatus {
  OPEN
  PAUSE
  CLOSE
}

enum PendingStatuses {
  IN_TRANSIT
  REJECT
  CONFIRM
  CANCEL
}

enum RejectMode {
  RETURN_TO_SOURCE
  WRITE_OFF
  RESEND
}

model Tool {
  id String @id @default(uuid())

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  name           String
  status         ToolStatus @default(ON_OBJECT)
  serialNumber   String?    @unique @map("serial_number")
  description    String?
  originalSerial String?    @map("original_serial")

  isBag    Boolean   @default(false)
  bagItems BagItem[]

  isBulk   Boolean @default(false)
  quantity Int     @default(1)

  storage  Object? @relation(fields: [objectId], references: [id])
  objectId String? @map("object_id")

  comment String?

  inTransit       PendingTransfersTools[]
  history         ToolHistory[]
  statusHistories ToolStatusHistory[]
}

model BagItem {
  id String @id @default(uuid())

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  name     String
  quantity Int

  bag    Tool   @relation(fields: [toolId], references: [id])
  toolId String @map("tool_id")
}

enum ToolStatus {
  ON_OBJECT
  IN_TRANSIT
  IN_REPAIR
  LOST
  WRITTEN_OFF
}

model PendingTransfersTools {
  id String @id @default(uuid())

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  status PendingStatuses

  photoUrl         String?
  rejectionComment String?
  rejectMode       RejectMode?

  fromObject   Object? @relation("pending_tools_from_object_fk", fields: [fromObjectId], references: [id])
  fromObjectId String?

  quantity Int @default(1)

  toObject   Object @relation("pending_tools_to_object_fk", fields: [toObjectId], references: [id])
  toObjectId String

  tool   Tool   @relation(fields: [toolId], references: [id])
  toolId String
}

model ToolHistory {
  id String @id @default(uuid())

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  action ToolActions

  tool   Tool   @relation(fields: [toolId], references: [id], onDelete: Cascade)
  toolId String @map("tool_id")

  movedBy User   @relation(fields: [userId], references: [id])
  userId  String @map("user_id")

  fromObject   Object? @relation(fields: [fromObjectId], references: [id], name: "tool_from_object_fk")
  fromObjectId String?

  toObject   Object @relation(fields: [toObjectId], references: [id], name: "tool_to_object_fk")
  toObjectId String

  comment String?

  quantity Int?
}

enum ToolActions {
  CONFIRM
  TRANSFER
  REJECT
  CANCEL
  RETURN_TO_SOURCE
  ADD
  WRITTEN_OFF
}

model ToolStatusHistory {
  id String @id @default(uuid())

  createdAt DateTime @default(now()) @map("created_at")

  tool   Tool   @relation(fields: [toolId], references: [id], onDelete: Cascade)
  toolId String @map("tool_id")

  changedBy User   @relation(fields: [userId], references: [id])
  userId    String @map("user_id")

  fromStatus ToolStatus
  toStatus   ToolStatus

  comment String?
}

model Device {
  id String @id @default(uuid())

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  name           String
  status         ToolStatus @default(ON_OBJECT)
  serialNumber   String     @unique @map("serial_number")
  originalSerial String?    @map("original_serial")

  storage  Object? @relation(fields: [objectId], references: [id])
  objectId String? @map("object_id")

  inTransit       PendingTransfersDevices[]
  history         DeviceHistory[]
  statusHistories DeviceStatusHistory[]
}

enum DeviceStatus {
  ON_OBJECT
  IN_TRANSIT
  IN_REPAIR
  LOST
  WRITTEN_OFF
}

model PendingTransfersDevices {
  id String @id @default(uuid())

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  status           PendingStatuses
  photoUrl         String?
  rejectionComment String?
  rejectMode       RejectMode?

  fromObject   Object? @relation("pending_devices_from_object_fk", fields: [fromObjectId], references: [id])
  fromObjectId String?

  toObject   Object @relation("pending_devices_to_object_fk", fields: [toObjectId], references: [id])
  toObjectId String

  device   Device @relation(fields: [deviceId], references: [id])
  deviceId String
}

model DeviceHistory {
  id String @id @default(uuid())

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  action DeviceActions

  device   Device @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  deviceId String @map("device_id")

  movedBy User   @relation(fields: [userId], references: [id])
  userId  String @map("user_id")

  fromObject   Object? @relation(fields: [fromObjectId], references: [id], name: "device_from_object_fk")
  fromObjectId String?

  toObject   Object @relation(fields: [toObjectId], references: [id], name: "device_to_object_fk")
  toObjectId String
}

enum DeviceActions {
  CONFIRM
  TRANSFER
  REJECT
  CANCEL
  RETURN_TO_SOURCE
}

model DeviceStatusHistory {
  id String @id @default(uuid())

  createdAt DateTime @default(now()) @map("created_at")

  device   Device @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  deviceId String @map("device_id")

  changedBy User   @relation(fields: [userId], references: [id])
  userId    String @map("user_id")

  fromStatus ToolStatus
  toStatus   ToolStatus

  comment String?
}

model Clothes {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  type   ClothesType
  season Season

  name String

  clothingSize   ClothingSize? @relation(fields: [clothingSizeId], references: [id])
  clothingSizeId String?       @map("clothing_size_id")

  clothingHeight   ClothingHeight? @relation(fields: [clothingHeightId], references: [id])
  clothingHeightId String?         @map("clothing_height_id")

  footwearSize   FootwearSize? @relation(fields: [footwearSizeId], references: [id])
  footwearSizeId String?       @map("footwear_size_id")

  price    Int
  quantity Int

  provider   Provider @relation(fields: [providerId], references: [id])
  providerId String   @map("provider_id")

  storage  Object @relation(fields: [objectId], references: [id])
  objectId String @map("object_id")

  employeeClothes EmployeeClothing[]
  history         ClothesHistory[]
  inTransit       PendingTransfersClothes[]

  @@unique([objectId, name, type, season, clothingHeightId, clothingSizeId, footwearSizeId], name: "objectId_name_type_season_clothingHeightId_clothingSizeId_footwearSizeId")
}

model ClothingSize {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  size      String     @unique
  clothes   Clothes[]
  employees Employee[]
}

model ClothingHeight {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  height    String     @unique
  clothes   Clothes[]
  employees Employee[]
}

model FootwearSize {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  size      String     @unique
  clothes   Clothes[]
  employees Employee[]
}

model Provider {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  name    String    @unique
  Clothes Clothes[]
}

enum ClothesType {
  CLOTHING
  FOOTWEAR
}

enum Season {
  SUMMER
  WINTER
  ALL
}

model PendingTransfersClothes {
  id String @id @default(uuid())

  quantity         Int
  photoUrl         String?
  rejectionComment String?
  rejectMode       RejectMode?
  status           PendingStatuses
  createdAt        DateTime        @default(now()) @map("created_at")
  updatedAt        DateTime        @updatedAt @map("updated_at")

  fromObject   Object @relation("pending_clothes_from_object_fk", fields: [fromObjectId], references: [id])
  fromObjectId String

  toObject   Object @relation("pending_clothes_to_object_fk", fields: [toObjectId], references: [id])
  toObjectId String

  clothes   Clothes @relation(fields: [clothesId], references: [id])
  clothesId String
}

model ClothesHistory {
  id String @id @default(uuid())

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  action ClothesActions

  clothes   Clothes @relation(fields: [clothesId], references: [id])
  clothesId String  @map("clothes_Id")

  movedBy User   @relation(fields: [userId], references: [id])
  userId  String @map("user_id")

  quantity Int

  fromObject   Object? @relation(fields: [fromObjectId], references: [id], name: "clothes_from_object_fk")
  fromObjectId String?

  toObject   Object? @relation(fields: [toObjectId], references: [id], name: "clothes_to_object_fk")
  toObjectId String?

  toEmployee Employee? @relation(fields: [employeeId], references: [id])
  employeeId String?   @map("employee_id")

  writeOffComment String?
}

enum ClothesActions {
  ADD
  TRANSFER
  CONFIRM
  GIVE_TO_EMPLOYEE
  RETURN_FROM_EMPLOYEE
  WRITTEN_OFF
  CANCEL
  RETURN_TO_SOURCE
}

model Tablet {
  id String @id @default(uuid())

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  name         String
  serialNumber String @unique @map("serial_number")

  status TabletStatus @default(ACTIVE)

  employee   Employee? @relation(fields: [employeeId], references: [id])
  employeeId String?   @map("employee_id")

  history TabletHistory[]
}

enum TabletStatus {
  ACTIVE
  INACTIVE
  IN_REPAIR
  LOST
  WRITTEN_OFF
}

model TabletHistory {
  id String @id @default(uuid())

  createdAt DateTime @default(now()) @map("created_at")

  tablet   Tablet @relation(fields: [tabletId], references: [id], onDelete: Cascade)
  tabletId String @map("tablet_id")

  changedBy User   @relation(fields: [userId], references: [id])
  userId    String @map("user_id")

  fromStatus TabletStatus?
  toStatus   TabletStatus?

  fromEmployee   Employee? @relation(fields: [fromEmployeeId], references: [id], name: "tablet_from_employee_fk")
  fromEmployeeId String?

  toEmployee   Employee? @relation(fields: [toEmployeeId], references: [id], name: "tablet_to_employee_fk")
  toEmployeeId String?

  comment String?
}

model Employee {
  id String @id @default(uuid())

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  type employeeType @default(ACTIVE)

  dob String @default("2007-02-02")

  firstName          String    @map("first_name")
  lastName           String    @map("last_name")
  fatherName         String?   @map("father_name")
  phoneNumber        String    @unique @map("phone_number")
  country            Countries @default(RU)
  passportSerial     String
  passportNumber     String
  whereIssued        String
  issueDate          String
  registrationRegion String
  registrationCity   String
  registrationStreet String
  registrationBuild  String
  registrationFlat   String?
  startWorkDate      String    @default("2007-02-02")

  warnings EmployeeWarning[]

  clothingSize   ClothingSize? @relation(fields: [clothingSizeId], references: [id])
  clothingSizeId String?       @map("clothing_size_id")

  clothingHeight   ClothingHeight? @relation(fields: [clothingHeightId], references: [id])
  clothingHeightId String?         @map("clothing_height_id")

  footwearSize   FootwearSize? @relation(fields: [footwearSizeId], references: [id])
  footwearSizeId String?       @map("footwear_size_id")

  status Statuses @default(OK)

  position String

  clothing       EmployeeClothing[]
  clothesHistory ClothesHistory[]
  devices        Tablet[]
  skills         Skill[]
  shifts         ShiftEmployee[]
  shiftsTemplate ShiftTemplateEmployee[]
  archive        EmployeeArchive?
  documents      EmployeeDocument[]

  workPlace Object? @relation(fields: [objectId], references: [id])
  objectId  String? @map("object_id")

  fromTabletHistories TabletHistory[] @relation("tablet_from_employee_fk")
  toTabletHistories   TabletHistory[] @relation("tablet_to_employee_fk")

  @@unique([passportSerial, passportNumber], name: "employee_identity_unique")
}

model EmployeeDocument {
  id String @id @default(uuid())

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  name    String
  docSrc  String
  expDate String

  employee   Employee @relation(fields: [employeeId], references: [id])
  employeeId String
}

model EmployeeWarning {
  id String @id @default(uuid())

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  warningType EmployeeWarningType
  message     String

  employee   Employee @relation(fields: [employeeId], references: [id])
  employeeId String
}

enum EmployeeWarningType {
  CLOTHING_SUMMER
  CLOTHING_WINTER
  FOOTWEAR_SUMMER
  FOOTWEAR_WINTER
  PASSPORT
}

enum employeeType {
  ACTIVE
  ARCHIVE
}

enum Countries {
  RU
  KZ
  TJ
  KG
  BY
  AZ
}

enum Statuses {
  OK // üü¢ –í—Å—ë –≤ –ø–æ—Ä—è–¥–∫–µ
  WARNING // üü° –ï—Å—Ç—å –º–æ–º–µ–Ω—Ç—ã, —Ç—Ä–µ–±—É—é—â–∏–µ –≤–Ω–∏–º–∞–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å—Ä–æ–∫ –ø–æ–¥—Ö–æ–¥–∏—Ç)
  OVERDUE // üî¥ –ù–∞—Ä—É—à–µ–Ω—ã —Å—Ä–æ–∫–∏ (–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ —á—Ç–æ-—Ç–æ)
  INACTIVE
}

model Skill {
  id String @id @default(uuid())

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  skill String @unique

  employees Employee[]
}

model EmployeeArchive {
  id         String   @id @default(uuid())
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  employeeId String   @unique

  comment    String?
  archivedAt DateTime @default(now())

  changedBy User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String @map("user_id")
}

model EmployeeClothing {
  id String @id @default(uuid())

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  employeeId String   @map("employee_id")

  clothing   Clothes? @relation(fields: [clothingId], references: [id], onDelete: Cascade)
  clothingId String?  @map("clothing_id")

  customClothes   CustomClothes? @relation(fields: [customClothesId], references: [id], onDelete: Cascade)
  customClothesId String?        @map("custom_clothes_id")

  issuedAt        DateTime @default(now()) @map("issued_at")
  priceWhenIssued Decimal  @map("price_when_issued") @db.Decimal(10, 2)
  debtAmount      Decimal  @map("debt_amount ") @db.Decimal(10, 2)
  isReturned      Boolean  @default(false) @map("is_returned ")
}

model CustomClothes {
  id String @id @default(uuid())

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  name     String
  size     String?
  height   String?
  price    Decimal     @db.Decimal(10, 2)
  season   Season
  type     ClothesType
  issuedAt DateTime    @default(now()) @map("issued_at")

  employeeClothing EmployeeClothing[]
}

model Shift {
  id String @id @default(uuid())

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  shiftDate DateTime @map("shift_date")

  plannedHours Int @map("planned_hours")

  totalHours Int @map("worked_hours")

  object   Object @relation(fields: [objectId], references: [id])
  objectId String @map("object_id")

  employees ShiftEmployee[]

  updatedReason String?

  // –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –∫—Ç–æ —Å–æ–∑–¥–∞–ª
  createdBy   User?   @relation(fields: [createdById], references: [id])
  createdById String? @map("created_by_id")
}

model ShiftEmployee {
  id String @id @default(uuid())

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  shift   Shift  @relation(fields: [shiftId], references: [id], onDelete: Cascade)
  shiftId String @map("shift_id")

  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  employeeId String   @map("employee_id")

  workedHours Int? @map("worked_hours")

  present Boolean @default(true)
  isLocal Boolean @default(false)

  absenceReason String? @map("absence_reason")
  task          String?

  @@unique([shiftId, employeeId], name: "shift_employee_unique")
  @@index([shiftId])
  @@index([employeeId])
}

model ShiftTemplate {
  id String @id @default(uuid())

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  name String @unique

  plannedHours Int @map("planned_hours")

  object   Object @relation(fields: [objectId], references: [id])
  objectId String @map("object_id")

  employees ShiftTemplateEmployee[]

  createdBy   User?   @relation(fields: [createdById], references: [id])
  createdById String? @map("created_by_id")
}

model ShiftTemplateEmployee {
  id String @id @default(uuid())

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  template   ShiftTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  templateId String        @map("template_id")

  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  employeeId String   @map("employee_id")

  workedHours Int? @map("worked_hours")

  present Boolean @default(true)
  isLocal Boolean @default(false)

  absenceReason String? @map("absence_reason")
  task          String?

  @@index([templateId])
  @@index([employeeId])
}

model ActionLog {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now()) @map("created_at")

  user   User   @relation(fields: [userId], references: [id])
  userId String @map("user_id")

  action   String
  entity   String
  entityId String @map("entity_id")

  details Json? // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
}
